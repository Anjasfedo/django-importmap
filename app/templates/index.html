{% extends 'base.html' %}
{% block content %}
  Lorem ipsum dolor sit amet consectetur adipisicing elit. Quod quis, voluptatem, fuga assumenda corporis recusandae optio rerum laboriosam ab, error minima rem natus praesentium mollitia officiis maxime molestias quas qui.<div>
    <video id="video" autoplay></video>
    {% csrf_token %}
  </div>
{% endblock %}
{% block page_js %}
  <script type="module">
    import { BrowserQRCodeReader } from '@zxing/library'
    
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 8000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.onmouseenter = Swal.stopTimer
        toast.onmouseleave = Swal.resumeTimer
      }
    })
    
    const codeReader = new BrowserQRCodeReader()
    const startQRCodeScan = () => {
      codeReader
        .getVideoInputDevices(undefined, 'video')
        .then((result) => {
          if (result && result.length) {
            codeReader
              .decodeFromInputVideoDevice(result[0].deviceId, 'video')
              .then((result) => {
                let qrDataFromReader = result.text
    
                // Prepare a post request so it can be sent to the
                // qr_codes#create action using Rails ujs
                let formData = new FormData()
                formData.append('qr_data', qrDataFromReader)
    
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value
                formData.append('csrfmiddlewaretoken', csrfToken)
    
                // Send QR code data as JSON to the qr_codes#create action
                // using Rails ujs
                fetch('/qr_codes', {
                  method: 'POST',
                  body: formData
                })
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok')
                    }
                    return response.json()
                  })
                  .then((data) => {
                    // Show response using SweetAlert toast
    
                    Toast.fire({
                      icon: data.type === 'success' ? 'success' : 'error',
                      title: data.message
                    })
    
                    console.log(data)
    
                    // Restart QR code scan after showing toast
                    startQRCodeScan()
                  })
                  .catch((error) => {
                    console.error('Error:', error)
                    // Show error toast using SweetAlert
    
                    Toast.fire({
                      icon: 'error',
                      title: 'An error occurred. Please try again later.'
                    })
    
                    // Restart QR code scan after showing toast
                    startQRCodeScan()
                  })
              })
              .catch((err) => {
                console.error('Error reading QR code:', err)
                // Show error toast using SweetAlert
    
                Toast.fire({
                  icon: 'error',
                  title: 'Error reading QR code. Please try again.'
                })
    
                // Restart QR code scan after showing toast
                startQRCodeScan()
              })
          } else {
            console.error('No video input devices found.')
            // Show error toast using SweetAlert
    
            Toast.fire({
              icon: 'error',
              title: 'No video input devices found.'
            })
    
            // Restart QR code scan after showing toast
            startQRCodeScan()
          }
        })
        .catch((err) => {
          console.error('Error accessing video input devices:', err)
          // Show error toast using SweetAlert
    
          Toast.fire({
            icon: 'error',
            title: 'Error accessing video input devices. Please try again.'
          })
    
          // Restart QR code scan after showing toast
          startQRCodeScan()
        })
    }
    
    // Start QR code scan initially
    startQRCodeScan()
  </script>
{% endblock %}
